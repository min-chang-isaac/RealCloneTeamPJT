<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/post.css}">
</head>
<body>
<div class="page">
    <!-- Í≤åÏãúÍ∏Ä Ïπ¥Îìú -->
    <div class="post-card">
        <div class="d-flex align-items-center gap-2 mb-3">
            <div class="profile"></div>
            <div class="fw-semibold">1234</div>
        </div>
        <div class="mb-3" th:text="${post.content}">
            Í≤åÏãúÍ∏Ä ÎÇ¥Ïö©ÏûÖÎãàÎã§
        </div>
        <div class="d-flex gap-3 text-secondary">
            <!-- Ï¢ãÏïÑÏöî Î≤ÑÌäº -->
            <form th:action="@{/post/like}" method="post" class="d-inline">
                <button type="submit" class="btn-action">
                    <span th:text="${post.likedByMe ? '‚ù§Ô∏è Ï¢ãÏïÑÏöî' : 'ü§ç Ï¢ãÏïÑÏöî'}">ü§ç Ï¢ãÏïÑÏöî</span>
                    <span th:text="${post.likeCount}">0</span>
                </button>
            </form>
            <!-- ÎåìÍ∏Ä Î≤ÑÌäº -->
            <span onclick="toggleCommentSection()" style="cursor:pointer;">
                üí¨ ÎåìÍ∏Ä <span th:text="${commentCount}">0</span>
            </span>
        </div>
    </div>

    <!-- ÎåìÍ∏Ä ÏÑπÏÖò -->
    <div id="comment-section" style="display:none;">
        <!-- ÎåìÍ∏Ä ÏûÖÎ†• -->
        <div class="card mb-3">
            <div class="card-body">
                <form th:action="@{/post/comment/add}" method="post">
                    <textarea name="content" class="form-control mb-2" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required></textarea>
                    <button type="submit" class="btn btn-danger w-100">Îì±Î°ù</button>
                </form>
            </div>
        </div>

        <!-- Ï†ïÎ†¨ Î≤ÑÌäº -->
        <div class="d-flex justify-content-end gap-2 mb-3">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="sort-newest" onclick="sortComments('newest')">
                ÏµúÏã†Ïàú
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="sort-oldest" onclick="sortComments('oldest')">
                ÏãúÍ∞ÑÏàú
            </button>
        </div>

        <!-- ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏ -->
        <div class="comment-list">
            <div class="comment" th:each="comment : ${post.comments}">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <div class="profile small"></div>
                    <span class="fw-semibold" th:text="${comment.author}">Ïú†Ï†Ä</span>
                    <span class="text-muted small" th:text="${comment.createdAt != null ? #temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm') : '2026-01-19 14:30'}">2026-01-19 14:30</span>
                </div>
                
                <!-- ÎåìÍ∏Ä ÎÇ¥Ïö© -->
                <div class="mb-2" th:text="${comment.content}" 
                     th:id="'comment-content-' + ${comment.id}">
                    ÎåìÍ∏Ä ÎÇ¥Ïö©
                </div>
                
                <!-- ÎåìÍ∏Ä ÏàòÏ†ï Ìèº -->
                <div class="edit-form" th:id="'edit-form-' + ${comment.id}">
                    <form th:action="@{/post/comment/edit}" method="post">
                        <input type="hidden" name="commentId" th:value="${comment.id}">
                        <textarea name="content" class="form-control mb-2" th:text="${comment.content}" required></textarea>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-primary">Ï†ÄÏû•</button>
                            <button type="button" class="btn btn-sm btn-secondary"
                                    th:onclick="'toggleEdit(' + ${comment.id} + ')'">Ï∑®ÏÜå</button>
                        </div>
                    </form>
                </div>
                
                <!-- ÎåìÍ∏Ä Ïï°ÏÖò -->
                <div class="comment-actions d-flex align-items-center gap-2">
                    <!-- Ï¢ãÏïÑÏöî -->
                    <form th:action="@{/post/comment/like}" method="post" class="d-inline">
                        <input type="hidden" name="commentId" th:value="${comment.id}">
                        <button type="submit" class="btn-action">
                            <span th:text="${comment.likedByMe ? '‚ù§Ô∏è' : 'ü§ç'}">ü§ç</span>
                            <span th:text="${comment.likeCount}">0</span>
                        </button>
                    </form>
                    
                    <span th:onclick="'toggleReply(' + ${comment.id} + ')'">üí¨ 0</span>
                    <span th:onclick="'toggleEdit(' + ${comment.id} + ')'">‚úîÔ∏è ÏàòÏ†ï</span>
                    
                    <!-- ÏÇ≠Ï†ú -->
                    <form th:action="@{/post/comment/delete}" method="post" 
                          class="d-inline"
                          onsubmit="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">
                        <input type="hidden" name="commentId" th:value="${comment.id}">
                        <button type="submit" class="btn-action">
                            ‚úñÔ∏è ÏÇ≠Ï†ú
                        </button>
                    </form>
                </div>
                
                <!-- ÎåÄÎåìÍ∏Ä ÏûÖÎ†• Ìèº -->
                <div class="reply-form" th:id="'reply-form-' + ${comment.id}">
                    <form th:action="@{/post/comment/reply}" method="post">
                        <input type="hidden" name="parentId" th:value="${comment.id}">
                        <textarea name="content" class="form-control mb-2" placeholder="ÎåÄÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required></textarea>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-danger">Îì±Î°ù</button>
                            <button type="button" class="btn btn-sm btn-secondary"
                                    th:onclick="'toggleReply(' + ${comment.id} + ')'">Ï∑®ÏÜå</button>
                        </div>
                    </form>
                </div>
                
                <!-- ÎåÄÎåìÍ∏Ä Î™©Î°ù -->
                <div class="reply" th:each="reply : ${comment.replies}">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <div class="profile tiny"></div>
                        <span class="fw-semibold small" th:text="${reply.author}">Ïú†Ï†Ä</span>
                        <span class="text-muted small" th:text="${reply.createdAt != null ? #temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm') : '2026-01-19 14:35'}">2026-01-19 14:35</span>
                    </div>
                    
                    <!-- ÎåÄÎåìÍ∏Ä ÎÇ¥Ïö© -->
                    <div class="mb-2 small" th:text="${reply.content}" 
                         th:id="'reply-content-' + ${comment.id} + '-' + ${reply.id}">
                        ÎåÄÎåìÍ∏Ä ÎÇ¥Ïö©
                    </div>
                    
                    <!-- ÎåÄÎåìÍ∏Ä ÏàòÏ†ï Ìèº -->
                    <div class="edit-form" th:id="'reply-edit-form-' + ${comment.id} + '-' + ${reply.id}">
                        <form th:action="@{/post/comment/reply/edit}" method="post">
                            <input type="hidden" name="parentId" th:value="${comment.id}">
                            <input type="hidden" name="replyId" th:value="${reply.id}">
                            <textarea name="content" class="form-control mb-2" th:text="${reply.content}" required></textarea>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-sm btn-primary">Ï†ÄÏû•</button>
                                <button type="button" class="btn btn-sm btn-secondary"
                                        th:onclick="'toggleReplyEdit(' + ${comment.id} + ',' + ${reply.id} + ')'">Ï∑®ÏÜå</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="comment-actions">
                        <!-- ÎåÄÎåìÍ∏Ä Ï¢ãÏïÑÏöî -->
                        <form th:action="@{/post/comment/reply/like}" method="post" class="d-inline">
                            <input type="hidden" name="parentId" th:value="${comment.id}">
                            <input type="hidden" name="replyId" th:value="${reply.id}">
                            <button type="submit" class="btn-action">
                                <span th:text="${reply.likedByMe ? '‚ù§Ô∏è' : 'ü§ç'}">ü§ç</span>
                                <span th:text="${reply.likeCount}">0</span>
                            </button>
                        </form>
                        
                        <span th:onclick="'toggleReplyEdit(' + ${comment.id} + ',' + ${reply.id} + ')'">‚úîÔ∏è ÏàòÏ†ï</span>
                        
                        <!-- ÎåÄÎåìÍ∏Ä ÏÇ≠Ï†ú -->
                        <form th:action="@{/post/comment/reply/delete}" method="post" 
                              class="d-inline"
                              onsubmit="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">
                            <input type="hidden" name="parentId" th:value="${comment.id}">
                            <input type="hidden" name="replyId" th:value="${reply.id}">
                            <button type="submit" class="btn-action">
                                ‚úñÔ∏è ÏÇ≠Ï†ú
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ÌòÑÏû¨ Ï†ïÎ†¨ ÏÉÅÌÉú
    let currentSort = 'newest'; // Í∏∞Î≥∏Í∞í: ÏµúÏã†Ïàú
    
    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏµúÏã†ÏàúÏúºÎ°ú Ï¥àÍ∏∞Ìôî
    window.addEventListener('DOMContentLoaded', function() {
        // ÎåìÍ∏Ä ÏÑπÏÖò ÏÉÅÌÉú Î≥µÏõê
        const commentSectionOpen = sessionStorage.getItem('commentSectionOpen');
        if (commentSectionOpen === 'true') {
            document.getElementById('comment-section').style.display = 'block';
        }
        
        // ÏµúÏã†ÏàúÏúºÎ°ú Ï¥àÍ∏∞Ìôî
        if (document.querySelector('.comment-list .comment')) {
            sortComments('newest');
        }
    });
    
    // ÎåìÍ∏Ä ÏÑπÏÖò ÌÜ†Í∏Ä
    function toggleCommentSection() {
        const commentSection = document.getElementById('comment-section');
        if (commentSection.style.display === 'none') {
            commentSection.style.display = 'block';
            sessionStorage.setItem('commentSectionOpen', 'true');
        } else {
            commentSection.style.display = 'none';
            sessionStorage.setItem('commentSectionOpen', 'false');
        }
    }
    
    // ÏàòÏ†ï Ìèº ÌÜ†Í∏Ä
    function toggleEdit(commentId) {
        const content = document.getElementById('comment-content-' + commentId);
        const editForm = document.getElementById('edit-form-' + commentId);
        
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
        editForm.classList.toggle('active');
    }
    
    // ÎåÄÎåìÍ∏Ä Ìèº ÌÜ†Í∏Ä
    function toggleReply(commentId) {
        const replyForm = document.getElementById('reply-form-' + commentId);
        replyForm.classList.toggle('active');
    }
    
    // ÎåÄÎåìÍ∏Ä ÏàòÏ†ï Ìèº ÌÜ†Í∏Ä
    function toggleReplyEdit(parentId, replyId) {
        const content = document.getElementById('reply-content-' + parentId + '-' + replyId);
        const editForm = document.getElementById('reply-edit-form-' + parentId + '-' + replyId);
        
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
        editForm.classList.toggle('active');
    }
    
    // ÎåìÍ∏Ä Ï†ïÎ†¨
    function sortComments(order) {
        const commentList = document.querySelector('.comment-list');
        const comments = Array.from(commentList.querySelectorAll('.comment'));
        
        if (order === 'newest') {
            // ÏµúÏã†Ïàú (Ïó≠Ïàú)
            comments.reverse();
            document.getElementById('sort-newest').classList.add('active');
            document.getElementById('sort-oldest').classList.remove('active');
        } else {
            // ÏãúÍ∞ÑÏàú (ÏõêÎûò ÏàúÏÑúÎ°ú ÎêòÎèåÎ¶¨Í∏∞)
            if (currentSort === 'newest') {
                comments.reverse();
            }
            document.getElementById('sort-newest').classList.remove('active');
            document.getElementById('sort-oldest').classList.add('active');
        }
        
        // ÎåìÍ∏Ä Îã§Ïãú Ï∂îÍ∞Ä
        comments.forEach(comment => {
            commentList.appendChild(comment);
        });
        
        currentSort = order;
    }
    
    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏµúÏã†ÏàúÏúºÎ°ú Ï¥àÍ∏∞Ìôî
    window.addEventListener('DOMContentLoaded', function() {
        sortComments('newest');
    });
</script>
</body>
</html>