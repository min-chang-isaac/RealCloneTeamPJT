<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/post.css}">
</head>
<body>
	<div class="container-fluid px-0">
	  <div class="mx-auto bg-white min-vh-100 border-start border-end"
	       style="max-width:430px;">
	  
	  <!-- Ìó§Îçî Ï∂îÍ∞Ä -->
	  <header class="bg-white border-bottom py-3 px-3 d-flex justify-content-between align-items-center">
	      <a th:href="@{/home}" 
	         class="d-inline-flex align-items-center justify-content-center" 
	         style="cursor: pointer; font-size: 24px; line-height: 1; width: 24px; height: 24px; text-decoration: none; color: black;"
	         aria-label="Êàª„Çã">„Äà</a>
	      <span class="fw-bold fs-5">„Éù„Çπ„Éà</span>
	      
	      <div>
	          <!-- Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÏùº Îïå -->
	          <div th:if="${session.loginUser != null}">
	              <div th:replace="~{logout :: logoutButton}">
	                  <button class="btn btn-sm btn-outline-secondary">LOGOUT</button>
	              </div>
	          </div>
	          
	          <!-- ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉúÏùº Îïå - returnUrlÏóê ÌòÑÏû¨ URL ÏÇ¨Ïö© -->
	          <div th:if="${session.loginUser == null}">
	              <a th:href="@{/login(returnUrl=${#httpServletRequest.requestURI + (#httpServletRequest.queryString != null ? '?' + #httpServletRequest.queryString : '')})}" 
	                 class="btn btn-sm btn-outline-primary"
	                 style="font-size: 0.8rem; border-radius: 20px; padding: 4px 12px; text-decoration:none; font-weight: 500;">
	                 LOGIN
	              </a>
	          </div>
	      </div>
	  </header>
	  
    <!-- Í≤åÏãúÍ∏Ä Ïπ¥Îìú -->
	<div class="bg-white px-3 py-3 border-bottom">
		<div class="d-flex align-items-center gap-2 mb-2">
            <div class="profile"></div>
            <div class="fw-semibold"> „É¶„Éº„Ç∂„Éº</div>
        </div>
        <div class="mb-3" th:text="${post.content}">
            „Éù„Çπ„ÉàÂÜÖÂÆπ„Åß„Åô
        </div>
		<div class="d-flex gap-3 text-muted small">
			 <!-- Ï¢ãÏïÑÏöî Î≤ÑÌäº -->
			    <form th:action="@{/post/like}" method="post" class="d-inline" onsubmit="return checkLoginForAction(event)">
			        <button type="submit" class="btn-action">
			            <span th:text="${post.likedByMe ? '‚ù§Ô∏è „ÅÑ„ÅÑ„Å≠ÔºÅ' : 'ü§ç „ÅÑ„ÅÑ„Å≠ÔºÅ'}">ü§ç „ÅÑ„ÅÑ„Å≠ÔºÅ</span>
			            <span th:text="${post.likeCount}">0</span>
			        </button>
			    </form>
			    <!-- ÎåìÍ∏Ä Î≤ÑÌäº -->
			    <span onclick="toggleCommentSection()" style="cursor:pointer;">
			        üí¨ „Ç≥„É°„É≥„Éà <span th:text="${commentCount}">0</span>
			    </span>
			</div>
    </div>

    <!-- ÎåìÍ∏Ä ÏÑπÏÖò -->
    <div id="comment-section" style="display:none;">
		<!-- ÎåìÍ∏Ä ÏûÖÎ†• -->
		<div class="border-bottom px-3 py-3">
		        <form th:action="@{/post/comment/add}" method="post" onsubmit="return checkLoginForAction(event)">
		            <textarea id="commentInput" 
		                      name="content" 
		                      class="form-control mb-2" 
		                      placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
		                      onclick="checkLoginForClick(event)" 
		                      required></textarea>
							  <button type="submit"
							          class="btn btn-primary w-100 fw-bold rounded-pill py-2">
							    ÁôªÈå≤
							  </button>
		        </form>
		</div>

        <!-- Ï†ïÎ†¨ Î≤ÑÌäº -->
		<div class="px-3 py-3">  <!-- border-bottom Ï†úÍ±∞! -->
		        <div class="d-flex justify-content-end gap-2">
		            <button type="button" 
		                    class="btn btn-sm btn-outline-secondary rounded-pill px-3" 
		                    id="sort-newest" 
		                    onclick="sortComments('newest')">
		                Êñ∞ÁùÄÈ†Ü
		            </button>
		            <button type="button" 
		                    class="btn btn-sm btn-outline-secondary rounded-pill px-3" 
		                    id="sort-oldest" 
		                    onclick="sortComments('oldest')">
		                ÊäïÁ®øÈ†Ü
		            </button>
		        </div>
		    </div>
			
		<!-- ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏ -->
		<div class="comment-list">
		    <!-- ‚úÖ ÏàòÏ†ï: ${post.comments} ‚Üí ${comments} -->
		    <div class="comment px-3 py-3 border-bottom" th:each="comment : ${comments}">

				<div class="d-flex align-items-center gap-2 mb-2">
				            <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
				            <div th:if="${comment.user != null && comment.user.profileImageUrl != null}"
				                 class="profile small"
				                 th:style="'background-image: url(' + ${comment.user.profileImageUrl} + '); background-size: cover; background-position: center;'">
				            </div>
				            <div th:unless="${comment.user != null && comment.user.profileImageUrl != null}"
				                 class="profile small">
				            </div>
				            
				            <!-- ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ -->
				            <span class="fw-semibold" 
				                  th:text="${comment.user != null ? comment.user.name : comment.author}">
				                „É¶„Éº„Ç∂„Éº
				            </span>
				            
				            <span class="text-muted small" 
				                  th:text="${comment.createdAt != null ? #temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm') : '2026-01-19 14:30'}">
				                2026-01-19 14:30
				            </span>
				        </div>
                
                <!-- ÎåìÍ∏Ä ÎÇ¥Ïö© -->
                <div class="mb-2" th:text="${comment.content}" 
                     th:id="'comment-content-' + ${comment.id}">
                    „Ç≥„É°„É≥„ÉàÂÜÖÂÆπ
                </div>
                
                <!-- ÎåìÍ∏Ä ÏàòÏ†ï Ìèº -->
                <div class="edit-form" th:id="'edit-form-' + ${comment.id}">
                    <form th:action="@{/post/comment/edit}" method="post" onsubmit="return checkLoginForAction(event)">
                        <input type="hidden" name="commentId" th:value="${comment.id}">
                        <textarea name="content" class="form-control mb-2" th:text="${comment.content}" required></textarea>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-primary">‰øùÂ≠ò</button>
                            <button type="button" class="btn btn-sm btn-secondary"
                                    th:onclick="'toggleEdit(' + ${comment.id} + ')'">„Ç≠„É£„É≥„Çª„É´</button>
                        </div>
                    </form>
                </div>
                
                <!-- ÎåìÍ∏Ä Ïï°ÏÖò -->
                <div class="comment-actions d-flex align-items-center gap-2">
					 <!-- Ï¢ãÏïÑÏöî -->
					    <form th:action="@{/post/comment/like}" method="post" class="d-inline" onsubmit="return checkLoginForAction(event)">
					        <input type="hidden" name="commentId" th:value="${comment.id}">
					        <button type="submit" class="btn-action">
					            <span th:text="${comment.likedByMe ? '‚ù§Ô∏è' : 'ü§ç'}">ü§ç</span>
					            <span th:text="${comment.likeCount}">0</span>
					        </button>
					    </form>
					    
					    <span th:onclick="'toggleReply(' + ${comment.id} + ')'">üí¨ <span th:text="${comment.replies.size()}">0</span></span>
						<span th:onclick="'checkLoginAndToggleEdit(event,' + ${comment.id} + ')'">
						    ‚úîÔ∏è Á∑®ÈõÜ
						</span>
					    
					    <!-- ÏÇ≠Ï†ú -->
					    <form th:action="@{/post/comment/delete}" method="post" 
					          class="d-inline"
							  onsubmit="return checkLoginForAction(event) && confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„Åã?');">
					        <input type="hidden" name="commentId" th:value="${comment.id}">
					        <button type="submit" class="btn-action">
					            ‚úñÔ∏è ÂâäÈô§
					        </button>
					    </form>
					</div>
                
					<!-- ÎåÄÎåìÍ∏Ä ÏûÖÎ†• Ìèº -->
					<div class="reply-form" th:id="'reply-form-' + ${comment.id}">
					    <form th:action="@{/post/comment/reply}" method="post" onsubmit="return checkLoginForAction(event)">
					        <input type="hidden" name="parentId" th:value="${comment.id}">
					        <textarea name="content" 
					                  class="form-control mb-2" 
					                  placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
					                  onclick="checkLoginForClick(event)" 
					                  required></textarea>
					        <div class="d-flex gap-2">
					            <button type="submit" class="btn btn-sm btn-danger">ÁôªÈå≤</button>
					            <button type="button" class="btn btn-sm btn-secondary"
					                    th:onclick="'toggleReply(' + ${comment.id} + ')'">„Ç≠„É£„É≥„Çª„É´</button>
					        </div>
					    </form>
					</div>
                
                <!-- ÎåÄÎåìÍ∏Ä Î™©Î°ù -->
                <div class="reply bg-light rounded px-2 py-2 ms-4 mt-2" th:each="reply : ${comment.replies}">
                  
					<div class="d-flex align-items-center gap-2 mb-2">
					       <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
					       <div th:if="${reply.user != null && reply.user.profileImageUrl != null}"
					            class="profile tiny"
					            th:style="'background-image: url(' + ${reply.user.profileImageUrl} + '); background-size: cover; background-position: center;'">
					       </div>
					       <div th:unless="${reply.user != null && reply.user.profileImageUrl != null}"
					            class="profile tiny">
					       </div>
					       
					       <!-- ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ -->
					       <span class="fw-semibold small" 
					             th:text="${reply.user != null ? reply.user.name : reply.author}">
					           „É¶„Éº„Ç∂„Éº
					       </span>
					       
					       <span class="text-muted small" 
					             th:text="${reply.createdAt != null ? #temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm') : '2026-01-19 14:35'}">
					           2026-01-19 14:35
					       </span>
					   </div>
                    
                    <!-- ÎåÄÎåìÍ∏Ä ÎÇ¥Ïö© -->
                    <div class="mb-2 small" th:text="${reply.content}" 
                         th:id="'reply-content-' + ${comment.id} + '-' + ${reply.id}">
                        „Ç≥„É°„É≥„ÉàÂÜÖÂÆπ
                    </div>
                    
                    <!-- ÎåÄÎåìÍ∏Ä ÏàòÏ†ï Ìèº -->
                    <div class="edit-form" th:id="'reply-edit-form-' + ${comment.id} + '-' + ${reply.id}">
                        <form th:action="@{/post/comment/reply/edit}" method="post" onsubmit="return checkLoginForAction(event)">
                            <input type="hidden" name="parentId" th:value="${comment.id}">
                            <input type="hidden" name="replyId" th:value="${reply.id}">
                            <textarea name="content" class="form-control mb-2" th:text="${reply.content}" required></textarea>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-sm btn-primary">‰øùÂ≠ò</button>
                                <button type="button" class="btn btn-sm btn-secondary"
                                        th:onclick="'toggleReplyEdit(' + ${comment.id} + ',' + ${reply.id} + ')'">„Ç≠„É£„É≥„Çª„É´</button>
                            </div>
                        </form>
                    </div>
                    
					<div class="comment-actions">
					    <!-- ÎåÄÎåìÍ∏Ä Ï¢ãÏïÑÏöî -->
					    <form th:action="@{/post/comment/reply/like}" method="post" class="d-inline" onsubmit="return checkLoginForAction(event)">
					        <input type="hidden" name="parentId" th:value="${comment.id}">
					        <input type="hidden" name="replyId" th:value="${reply.id}">
					        <button type="submit" class="btn-action">
					            <span th:text="${reply.likedByMe ? '‚ù§Ô∏è' : 'ü§ç'}">ü§ç</span>
					            <span th:text="${reply.likeCount}">0</span>
					        </button>
					    </form>
					    
						<span th:onclick="'checkLoginAndToggleReplyEdit(event,' + ${comment.id} + ',' + ${reply.id} + ')'">
						    ‚úîÔ∏è Á∑®ÈõÜ
						</span>

					    
					    <!-- ÎåÄÎåìÍ∏Ä ÏÇ≠Ï†ú -->
					    <form th:action="@{/post/comment/reply/delete}" method="post" 
					          class="d-inline"
							  onsubmit="return checkLoginForAction(event) && confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">
					        <input type="hidden" name="parentId" th:value="${comment.id}">
					        <input type="hidden" name="replyId" th:value="${reply.id}">
					        <button type="submit" class="btn-action">
					            ‚úñÔ∏è ÂâäÈô§
					        </button>
					    </form>
					</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ Ï∂îÍ∞Ä: ÏÑúÎ≤ÑÏùò Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎ•º JavaScript Î≥ÄÏàòÎ°ú Ï†ÑÎã¨ -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const isLoggedIn = /*[[${isLoggedIn}]]*/ false;
    /*]]>*/
</script>

<!-- Bootstrap JS -->
<script th:src="@{/js/post.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>